{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static "admin/css/forms.css" %}">
{* comment *}
This special keyboard for entering some characters from the ISO 15919 transliteration standard for
Indic languages is a project at https://github.com/ShreyasKolpe/indic-character-input.
It was intended to develop a custom web component. For now the JS code is injected as is.
{* endcomment *}
<style type="text/css">
    indic-text-input {
        position: fixed;
        right: 0;
        z-index: 3;
    }
</style>
{% endblock %}

{% block content %}<div id="content-main">
    <indic-text-input></indic-text-input>
{% block object-tools %}
{% if change %}{% if not is_popup %}
  <ul class="object-tools">
    {% block object-tools-items %}
      {% change_form_object_tools %}
    {% endblock %}
  </ul>
{% endif %}{% endif %}
{% endblock %}
<form {% if has_file_field %}enctype="multipart/form-data" {% endif %}{% if form_url %}action="{{ form_url }}" {% endif %}method="post" id="{{ opts.model_name }}_form" novalidate>{% csrf_token %}{% block form_top %}{% endblock %}
<div>
{% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1">{% endif %}
{% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}
{% if save_on_top %}{% block submit_buttons_top %}{% submit_row %}{% endblock %}{% endif %}
{% if errors %}
    <p class="errornote">
    {% if errors|length == 1 %}{% translate "Please correct the error below." %}{% else %}{% translate "Please correct the errors below." %}{% endif %}
    </p>
    {{ adminform.form.non_field_errors }}
{% endif %}

{% block field_sets %}
{% for fieldset in adminform %}
  {% include "admin/includes/fieldset.html" %}
{% endfor %}
{% endblock %}

{% block after_field_sets %}{% endblock %}

{% block inline_field_sets %}
{% for inline_admin_formset in inline_admin_formsets %}
    {% include inline_admin_formset.opts.template %}
{% endfor %}
{% endblock %}

{% block after_related_objects %}{% endblock %}

{% block submit_buttons_bottom %}{% submit_row %}{% endblock %}

{% block admin_change_form_document_ready %}
    <script id="django-admin-form-add-constants"
            src="{% static 'admin/js/change_form.js' %}"
            {% if adminform and add %}
                data-model-name="{{ opts.model_name }}"
            {% endif %}
            async>
    </script>
{% endblock %}

{# JavaScript for prepopulated fields #}
{% prepopulated_fields_js %}

</div>
</form></div>
<script type="text/javascript">

function insertCharacterInto(characterId) {
    console.log(characterId, textInputToUse);
    var elem = document.getElementById(textInputToUse)
    var charToInsert = shadowRoot.getElementById(characterId).value
    var curPos = elem.selectionStart
    var text = elem.value;
    elem.value = text.slice(0, curPos) + charToInsert + text.slice(curPos);
    elem.focus()
    elem.selectionEnd = curPos + 1
}

function registerthis(inputId) {
    textInputToUse = inputId
    keyboardElem.hidden = false
}

function toUpper() {
    var elem = document.getElementById(textInputToUse)
    var curPos = elem.selectionStart;
    var curEnd = elem.selectionEnd;
    var text = elem.value;
    elem.value = text.slice(0, curPos) + text.slice(curPos, curEnd).toUpperCase() + text.slice(curEnd);
    elem.focus()
    elem.selectionEnd = curEnd
}


var shadowRoot;
var textInputToUse = null
var keyboardElem;

const textareaList = document.getElementsByTagName("textarea");
for(var i = 0; i < textareaList.length; i++){
    const elem = textareaList[i]
    console.log(elem.id)
    elem.addEventListener("focus", function() { registerthis(elem.id) })
    elem.setAttribute("spellcheck", "false")
}


class IndicTextInput extends HTMLElement {
    constructor() {
        super();

        this.attachShadow({mode: 'open'});
        shadowRoot = this.shadowRoot;
        const char_map = {
            0: {'a': 'disabled', 'ā': '_a', 'i': 'disabled', 'ī': '_i', 'u': 'disabled'},
            1: {'ū': '_u', 'r̥': '_r', 'e': 'disabled', 'ē': '_e', 'ai': 'disabled'},
            2: {'o': 'disabled', 'ō': '_o', 'ou': 'disabled', 'ṁ': '_m', 'ḥ': '_h'},
            3: {'k': 'disabled', 'kh': 'disabled', 'g': 'disabled', 'gh': 'disabled', 'ṅ': '_ng'},
            4: {'c': 'disabled', 'ch': 'disabled', 'j': 'disabled', 'jh': 'disabled', 'ñ': '_ny'},
            5: {'ṭ': '_t', 'ṭh': 'disabled', 'ḍ': '_d', 'ḍh': 'disabled', 'ṇ': '_N'},
            6: {'t': 'disabled', 'th': 'disabled', 'd': 'disabled', 'dh': 'disabled', 'n': 'disabled'},
            7: {'p': 'disabled', 'ph': 'disabled', 'b': 'disabled', 'bh': 'disabled', 'm': 'disabled'},
            8: {'ṟ': '_R', 'ḷ': '_l', 'ḻ': '_L', 'ś': '_sh', 'ṣ': '_Sh'}
        }

        const table = document.createElement("table");
        for(var key in char_map) {
            const row = document.createElement("tr")
            table.appendChild(row);
            for(var elem in char_map[key]) {
                const cell = document.createElement("td")
                if(char_map[key][elem] == 'disabled') {
                    cell.innerHTML = "<input type='button' value='" + elem +"' disabled>";
                }
                else {
                    cell.innerHTML = "<input type='button' value='" + elem + "' id='" + char_map[key][elem] + "' onclick=\"insertCharacterInto(this.id)\">";
                }
                row.appendChild(cell);
            }
        }

        const row = document.createElement("tr")
        table.appendChild(row);
        const cell = document.createElement("td")
        cell.setAttribute("colspan", 5)
        cell.innerHTML = "<input type='button' value='Uppercase' id='_toupper' onclick='toUpper()'>"
        row.appendChild(cell);

        this.shadowRoot.append(table);
        <!--this.hidden = true-->
        keyboardElem = this
    }
}
customElements.define("indic-text-input", IndicTextInput)

</script>
{% endblock %}
